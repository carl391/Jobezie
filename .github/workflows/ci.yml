# WAT Layer 1: Main CI Orchestrator
# Coordinates all CI stages with proper parallelism and dependencies
#
# Architecture (WAT Framework):
# - Layer 1 (This file): Orchestration & instructions
# - Layer 2 (_*.yml): Reusable workflows (agents)
# - Layer 3 (actions/): Composite actions (tools)

name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_call:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Stage 1: Parallel Linting (Backend + Frontend)
  # ============================================
  backend-lint:
    name: Backend Lint
    uses: ./.github/workflows/_backend-ci.yml
    with:
      stage: lint

  frontend-lint:
    name: Frontend Lint
    uses: ./.github/workflows/_frontend-ci.yml
    with:
      stage: lint

  # ============================================
  # Stage 2: Parallel Testing (depends on lint)
  # ============================================
  backend-test:
    name: Backend Test
    needs: backend-lint
    uses: ./.github/workflows/_backend-ci.yml
    with:
      stage: test

  frontend-test:
    name: Frontend Test
    needs: frontend-lint
    uses: ./.github/workflows/_frontend-ci.yml
    with:
      stage: test

  # ============================================
  # Stage 3: Security Scan (parallel with tests)
  # ============================================
  security:
    name: Security Scan
    needs: [backend-lint, frontend-lint]
    uses: ./.github/workflows/_security-scan.yml

  # ============================================
  # Stage 4: Build (depends on all checks)
  # ============================================
  build:
    name: Build Frontend
    needs: [backend-test, frontend-test, security]
    uses: ./.github/workflows/_frontend-ci.yml
    with:
      stage: build

  # ============================================
  # Quality Gate: All checks must pass
  # ============================================
  ci-complete:
    name: CI Complete
    needs: [backend-test, frontend-test, security, build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.backend-test.result }}" != "success" ] || \
             [ "${{ needs.frontend-test.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All CI checks passed successfully"
